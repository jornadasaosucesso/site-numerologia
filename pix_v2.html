<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento via Pix - Teste v4</title>
  <style>
    body {
      background: radial-gradient(circle at center, #000, #111);
      color: #fff;
      font-family: 'Playfair Display', serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      text-align: center;
    }
    h2 { color: gold; margin-bottom: 8px; }
    #qrcode { margin: 20px 0; padding: 12px; border-radius: 12px; box-shadow: 0 0 20px rgba(255,215,0,0.4); background:#fff;}
    #pixCode { background: #111; border: 1px solid gold; color: #fff; border-radius: 8px; width: 90%; max-width: 400px; padding: 10px; font-size: 0.9em; }
    button { margin-top: 18px; background: linear-gradient(90deg,#ffd700,#ffae42); color:#000; font-weight:bold; border:none; border-radius:10px; padding:10px 24px; cursor:pointer; font-size:1em; transition:0.3s; }
    button:hover { transform: scale(1.05); box-shadow:0 0 15px rgba(255,220,100,0.8); }
  </style>
</head>
<body>

  <p style="font-size:1.6em; margin-bottom:12px; font-weight:bold;">ESTAMOS EM FASE DE TESTES!</p>
  <p style="font-size:1.6em; margin-bottom:12px; font-weight:bold;">‚ö†Ô∏è O SITE ESTAR√Å ONLINE EM BREVE ‚ö†Ô∏è</p>

  <h2>üí∞ Clique em "PIX PAGO" para gerar seu acesso completo</h2>
  <p>Escaneie o QR Code abaixo ou copie o c√≥digo Pix para pagamento de R$ 35,00</p>

  <div id="qrcode"></div>
  <textarea id="pixCode" readonly>Escaneie o QR Code acima para pagamento</textarea>

  <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:18px;">
    <button id="btnGerar">Gerar Pix</button>
    <button id="copyBtn">Copiar Pix</button>
    <button id="btnPixPago">PIX PAGO</button>
    <button id="btnVoltar">Voltar</button>
  </div>

  <div id="mensagemPix" style="margin-top:15px; font-size:1em;"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {

      const nome = localStorage.getItem("nome") || "Jorge Viana";
      const data = localStorage.getItem("data_nascimento") || "26/05/1955";
      const nomeDestinatario = "JORGEBARBOSAVIANA";
      const cidade = "CAMPOGRANDE";
      const valor = "35.00"; // Valor em reais
      const chavePix = "f4246be4-ede3-4535-8248-93acbe51c006";

      function gerarCodigoInterno() {
        return Math.random().toString(36).substring(2,10).toUpperCase();
      }

      function gerarTXID(nome) {
        const clean = nome.replace(/[^A-Z0-9]/gi,'').toUpperCase();
        const txid = clean.substring(0,4) + gerarCodigoInterno().substring(0,8);
        return txid;
      }

      function calcularCRC16(payload) {
        let polinomio = 0x1021;
        let resultado = 0xFFFF;
        for (let i = 0; i < payload.length; i++) {
          resultado ^= payload.charCodeAt(i) << 8;
          for (let j = 0; j < 8; j++) {
            if ((resultado & 0x8000) !== 0) {
              resultado = (resultado << 1) ^ polinomio;
            } else {
              resultado <<= 1;
            }
            resultado &= 0xFFFF;
          }
        }
        return resultado.toString(16).toUpperCase().padStart(4,'0');
      }

      function formatarCampo(id, valor) {
        const len = valor.length.toString().padStart(2,'0');
        return id + len + valor;
      }

      let txid;

      document.getElementById("btnGerar").addEventListener("click", () => {
        txid = gerarTXID(nome);

        // Campos obrigat√≥rios Pix v2
        const payload = 
          formatarCampo("00", "01") +
          formatarCampo("26", formatarCampo("00", "BR.GOV.BCB.PIX") + formatarCampo("01", chavePix)) +
          formatarCampo("52", "0000") +
          formatarCampo("53", "986") +
          formatarCampo("54", valor) +
          formatarCampo("58", "BR") +
          formatarCampo("59", nomeDestinatario) +
          formatarCampo("60", cidade) +
          formatarCampo("62", formatarCampo("05", txid));

        const payloadSemCRC = payload + "6304"; // 63 √© CRC16
        const crc = calcularCRC16(payloadSemCRC);
        const brcode = payloadSemCRC + crc;

        document.getElementById('pixCode').value = brcode;

        QRCode.toDataURL(brcode, { width: 184 })
          .then(url => {
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = "";
            const img = document.createElement('img');
            img.src = url;
            img.alt = "QR Code para pagamento";
            qrcodeDiv.appendChild(img);
          })
          .catch(err => console.error("Erro ao gerar QR Code:", err));
      });

      document.getElementById('copyBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('pixCode').value);
        alert('C√≥digo Pix copiado!');
      });

      document.getElementById('btnVoltar').addEventListener('click', () => {
        window.location.href = "transicao.html";
      });

      document.getElementById("btnPixPago").addEventListener("click", () => {
        if(!txid) { alert("Primeiro gere o Pix!"); return; }
        const mensagemDiv = document.getElementById("mensagemPix");
        mensagemDiv.textContent = "‚è≥ AGUARDE 10 SEGUNDOS ‚è≥";

        fetch('/api/registrarPix', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ nome, data_nascimento: data, txid, valor })
        })
        .then(res => res.json())
        .then(resp => console.log(resp.message))
        .catch(err => console.error('Erro ao registrar PIX:', err));

        setTimeout(() => {
          let tempo = 5;
          mensagemDiv.textContent = `‚è±Ô∏è Redirecionando em ${tempo} segundos...`;
          const intervalo = setInterval(() => {
            tempo--;
            mensagemDiv.textContent = `‚è±Ô∏è Redirecionando em ${tempo} segundos...`;
            if(tempo <= 0) {
              clearInterval(intervalo);
              window.location.href = "resultado.html";
            }
          }, 1000);
        }, 2500);
      });

    });
  </script>
</body>
</html>
