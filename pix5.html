<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pagamento via Pix - v4</title>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha.js"></script>

  <style>
    body {
      background: radial-gradient(circle at center, #000, #111);
      color: #fff;
      font-family: 'Playfair Display', serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      text-align: center;
      padding: 20px;
    }

    h2 { color: gold; margin-bottom: 8px; }

    #qrcode {
      margin: 20px 0;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255,215,0,0.4);
      background: #fff;
    }

    #pixCode {
      background: #111;
      border: 1px solid gold;
      color: #fff;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      padding: 10px;
      font-size: 0.9em;
    }

    button {
      margin-top: 18px;
      background: linear-gradient(90deg,#ffd700,#ffae42);
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      padding: 10px 24px;
      cursor: pointer;
      font-size: 1em;
      transition: 0.3s;
    }

    button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255,220,100,0.8);
    }

    #btnProsseguir {
      background-color: #32CD32;
      color: #fff;
      display: none;
    }

    #comprovante, #uploadStatus {
      display: none;
    }

    .mensagem {
      font-size: 1.1em;
      margin-top: 20px;
      max-width: 600px;
    }
  </style>
</head>

<body>
  <p style="font-size:1.6em; margin-bottom:12px; font-weight:bold;">ESTAMOS EM FASE DE TESTES!</p>
  <p style="font-size:1.6em; margin-bottom:12px; font-weight:bold;">‚ö†Ô∏è O SITE ESTAR√Å ONLINE EM BREVE ‚ö†Ô∏è</p>

  <h2>üí∞ Clique em "PIX PAGO" para validar seu pagamento</h2>
  <p>Escaneie o QR Code abaixo ou copie o c√≥digo Pix para pagamento de R$ 35,00</p>

  <div id="qrcode"></div>
  <textarea id="pixCode" readonly>Escaneie o QR Code acima para pagamento</textarea>

  <p id="mensagemInterativa" class="mensagem"></p>

  <input type="file" id="comprovante" accept="image/*,application/pdf" />
  <p id="uploadStatus" style="font-weight: bold;"></p>

  <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:18px;">
    <button id="btnGerar">Gerar Pix</button>
    <button id="copyBtn">Copiar Pix</button>
    <button id="btnPixPago">PIX PAGO</button>
    <button id="btnProsseguir">PROSSEGUIR</button>
    <button id="btnVoltar">Voltar</button>
  </div>

  <div id="mensagemPix" style="margin-top:15px; font-size:1em;"></div>

  <script>
    const nome = localStorage.getItem("nome") || "Jorge Viana";
    const data = localStorage.getItem("data_nascimento") || "26/05/1955";
    const nomeDestinatario = "JORGEBARBOSAVIANA";
    const cidade = "CAMPOGRANDE";
    const valor = "35.00";
    const chavePix = "f4246be4-ede3-4535-8248-93acbe51c006";

    function gerarTXID(nome) {
      const clean = nome.replace(/[^A-Z0-9]/gi, '').toUpperCase();
      return clean.substring(0, 4) + Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function calcularCRC16(payload) {
      let polinomio = 0x1021, resultado = 0xFFFF;
      for (let i = 0; i < payload.length; i++) {
        resultado ^= payload.charCodeAt(i) << 8;
        for (let j = 0; j < 8; j++) {
          resultado = (resultado & 0x8000)
            ? (resultado << 1) ^ polinomio
            : resultado << 1;
        }
        resultado &= 0xFFFF;
      }
      return resultado.toString(16).toUpperCase().padStart(4, '0');
    }

    function formatarCampo(id, valor) {
      const len = valor.length.toString().padStart(2, '0');
      return id + len + valor;
    }

    function sha1(str) {
      const shaObj = new jsSHA("SHA-1", "TEXT");
      shaObj.update(str);
      return shaObj.getHash("HEX");
    }

    function normalizarData(data) {
      return data.replace(/\D/g, '');
    }

    function gerarIdUnico(nome, data) {
      const nomeLimpo = (nome || '').trim().toLowerCase();
      const dataLimpa = normalizarData(data);
      const base = `${nomeLimpo}|${dataLimpa}`;
      return sha1(base);
    }

    document.getElementById("btnGerar").addEventListener("click", () => {
      const txid = gerarTXID(nome);

      const payload =
        formatarCampo("00", "01") +
        formatarCampo("26",
          formatarCampo("00", "BR.GOV.BCB.PIX") +
          formatarCampo("01", chavePix)
        ) +
        formatarCampo("52", "0000") +
        formatarCampo("53", "986") +
        formatarCampo("54", valor) +
        formatarCampo("58", "BR") +
        formatarCampo("59", nomeDestinatario) +
        formatarCampo("60", cidade) +
        formatarCampo("62", formatarCampo("05", txid));

      const payloadSemCRC = payload + "6304";
      const crc = calcularCRC16(payloadSemCRC);
      const brcode = payloadSemCRC + crc;

      document.getElementById("pixCode").value = brcode;

      QRCode.toDataURL(brcode, { width: 184 }).then(url => {
        const qrcodeDiv = document.getElementById("qrcode");
        qrcodeDiv.innerHTML = "";
        const img = document.createElement("img");
        img.src = url;
        img.alt = "QR Code para pagamento";
        qrcodeDiv.appendChild(img);
      });

      const chaveUsuario = normalizarData(data) + nome + txid;
      localStorage.setItem(chaveUsuario, JSON.stringify({
        nome,
        data_nascimento: data,
        txid,
        pago: false
      }));

      document.getElementById("mensagemPix").textContent = "‚úÖ PIX Gerado com sucesso!";
    });

    document.getElementById("copyBtn").addEventListener("click", () => {
      const pixCode = document.getElementById("pixCode");
      pixCode.select();
      document.execCommand("copy");
      document.getElementById("mensagemPix").textContent = "üìã C√≥digo Pix copiado!";
    });

    const nome_original = localStorage.getItem("nome_original") || "";
    const data_original = localStorage.getItem("data_original") || "";

    console.log("üß† Nome original:", nome_original);
    console.log("üìÖ Data original:", data_original);

    document.getElementById("btnPixPago").addEventListener("click", () => {
      document.getElementById("mensagemInterativa").textContent =

        `Por favor, ${nome_original}, compartilhe o comprovante do PIX atrav√©s do bot√£o abaixo. Assim que enviar, clique em ‚ÄúPROSSEGUIR‚Äù para continuar.`;

      document.getElementById("comprovante").style.display = "block";
      document.getElementById("uploadStatus").style.display = "block";
      document.getElementById("btnPixPago").style.display = "none";
      document.getElementById("btnProsseguir").style.display = "inline-block";
    });

    document.getElementById("btnProsseguir").addEventListener("click", () => {
    const fileInput = document.getElementById("comprovante");
    const file = fileInput.files[0];
    const nome_original = localStorage.getItem("nome_original");
    const data_original = localStorage.getItem("data_original");

    const box = document.getElementById("box-validacao");
    const msg = document.getElementById("mensagem-validacao");
    const timer = document.getElementById("temporizador");

    console.log("üß† Nome original:", nome_original);
    console.log("üìÖ Data original:", data_original);

    if (!file) {
        msg.textContent = "üõë Voc√™ precisa fazer o upload do arquivo.";
        box.style.display = "block";
        return;
    }

    const extensoesValidas = ['pdf', 'jpg', 'jpeg', 'png'];
    const ext = file.name.split('.').pop().toLowerCase();
    if (!extensoesValidas.includes(ext)) {
        msg.textContent = "‚ùå Esse arquivo n√£o pode ser carregado. Verifique a extens√£o.";
        box.style.display = "block";
        return;
    }

    console.log("üìÇ Arquivo recebido:");
    console.log("Nome:", file.name);
    console.log("Tipo:", file.type);
    console.log("Tamanho:", file.size + " bytes");

    const reader = new FileReader();
    reader.onload = function () {
        const base64 = reader.result;
        console.log("üìÑ Conte√∫do base64:");
        console.log(base64);
        localStorage.setItem("comprovante_base64", base64);
    };
    reader.readAsDataURL(file);

    let tempo = 15;
    box.style.display = "block";
    msg.textContent = "‚è≥ Aguarde... estamos validando";
    timer.textContent = tempo;

    const intervalo = setInterval(() => {
        tempo--;
        timer.textContent = tempo;
        if (tempo <= 0) {
        clearInterval(intervalo);

        const validado = true; // aqui entra sua l√≥gica real com OCR

        if (validado) {
            msg.textContent = "‚úÖ VALIDADO";
            setTimeout(() => {
            window.location.href = "resultado.html";
            }, 1500);
        } else {
            msg.textContent = "‚ùå COMPROVANTE INV√ÅLIDO";
        }
        }
    }, 1000);
    });

    document.getElementById("btnVoltar").addEventListener("click", () => {
      window.location.href = "escolha.html";
    });

    document.getElementById("comprovante").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function () {
        localStorage.setItem("comprovante_base64", reader.result);
        document.getElementById("uploadStatus").textContent = "‚úÖ Comprovante carregado com sucesso!";
      };
      reader.readAsDataURL(file);
    });
  </script>

<div id="box-validacao" style="display:none; margin-top:20px; background:#222; padding:20px; border-radius:10px; color:#fff;">
  <p id="mensagem-validacao">‚è≥ Aguarde... estamos validando</p>
  <p id="temporizador" style="font-size:2rem;">15</p>
</div>

</body>
</html>