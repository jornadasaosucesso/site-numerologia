<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Par-Perfeito âœ¨ Escolha</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script> 
    
    <body class="pagina-escolha"></body>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet"> 
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Cormorant Garamond", "Segoe UI", serif;
            background: linear-gradient(135deg, #1f1c2c, #928dab);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            margin-top: 20px;
            font-size: 2em;
            text-align: center;
        }

        .container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 16px;
            padding: 25px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
            text-align: center;
        }

        .titulo-par {
            font-size: 16px;
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            color: #ffeaa7;
        }

        input {
            padding: 10px;
            border-radius: 8px;
            border: none;
            width: 80%;
            max-width: 260px;
            text-align: center;
            font-size: 1em;
            margin: 8px 0 16px 0;
            background-color: #fff;
            color: #333;
        }

        .input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .input-group input {
            flex: 1 1 120px;
            max-width: 180px;
        }

        .result-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }

        .dual-box {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .pair-info {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            text-align: center;
        }

        button {
            background: #ff69b4;
            color: #fff;
            border: none;
            padding: 12px 28px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 25px;
            transition: 0.3s;
        }

        button:hover {
            background: #ff85c1;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <h1>Descubra a energia entre Luz âœ¨ e Reflexo ðŸŒ—</h1>

    <div class="container">
        <div class="dual-box">
            
            <div>
                <h2 class="titulo-par">Luz âœ¨</h2>
                <div class="input-group"> 
                    <input type="text" id="nome1" placeholder="Nome de Luz" />
                    <input type="text" id="data1" placeholder="dd/mm/aaaa" />

                </div>
                <div class="result-box" id="info1"></div>
            </div>
            

            <div>
                <h2 class="titulo-par">Reflexo ðŸŒ—</h2>
                <div class="input-group"> 
                    <input type="text" id="nome2" placeholder="Nome de Reflexo" />
                    <input type="text" id="data2" placeholder="dd/mm/aaaa" />
                </div>
                <div class="result-box" id="info2"></div>
            </div>

        </div>

        <div class="pair-info" id="comum"></div>

        <div class="btn-group">
            <button id="verPar">ðŸ’ž Ver meu Par</button>
            <button id="btnSair" style="background: #e74c3c;">ðŸšª SAIR</button>
        </div>
    </div>

    <script>
        // FunÃ§Ã£o auxiliar para calcular informaÃ§Ãµes pessoais (Signo, Caminho)
        function calcularInfo(dataStr) {
            if (!dataStr) return null;
            const data = parseDataBR(dataStr);
            if (isNaN(data)) return null;

            const signos = [
                "CapricÃ³rnio", "AquÃ¡rio", "Peixes", "Ãries", "Touro", "GÃªmeos",
                "CÃ¢ncer", "LeÃ£o", "Virgem", "Libra", "EscorpiÃ£o", "SagitÃ¡rio"
            ];
            const datasSignos = [20, 19, 20, 20, 21, 21, 23, 23, 23, 23, 22, 22];
            let mes = data.getMonth();
            let dia = data.getDate();
            if (dia > datasSignos[mes]) mes = (mes + 1) % 12;

            const diaSemana = data.toLocaleDateString("pt-BR", { weekday: "long" });
            
            // CÃ¡lculo simplificado do Caminho de Vida (reduÃ§Ã£o simples)
            const soma = [...dataStr.replace(/-/g, '')].reduce((a, b) => a + parseInt(b), 0);
            const caminho = soma % 9 || 9;

            return { signo: signos[mes], diaSemana, caminho, diaNascimento: data.getDate() };
        }

        // FunÃ§Ã£o para mostrar as informaÃ§Ãµes pessoais em cada box
        function mostrarInfo(id, info) {
            const box = document.getElementById(id);
            if (!info) {
                box.innerHTML = "";
                return;
            }
            box.innerHTML = `
                <p>â™ˆ Signo: <strong>${info.signo}</strong></p>
                <p>ðŸ“… Dia da semana: <strong>${info.diaSemana}</strong></p>
                <p>ðŸ”¢ Caminho de vida: <strong>${info.caminho}</strong></p>
            `;
        }

        // FunÃ§Ã£o para buscar a compatibilidade real no CSV
        function buscarCompatibilidadeReal(dia1, dia2) {
            return new Promise((resolve, reject) => {
                const chave = `${String(dia1).padStart(2, '0')}X${String(dia2).padStart(2, '0')}`;
                
                if (typeof Papa === 'undefined') {
                    console.error("PapaParse nÃ£o carregado.");
                    // Retorna um objeto com ambos como 'N/A'
                    return resolve({ porcentagem: 'N/A', veredito: '' }); 
                }

                Papa.parse("dados/par_ideal_31_31.csv", {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        const linha = results.data.find(row => row.numero === chave);
                        
                        if (!linha || !linha.vibracao_harmonica || !linha.compatibilidade) {
                            return resolve({ porcentagem: 'N/A', veredito: 'NÃ£o encontrado' });
                        }
                        
                    
                        // 2. Extrai o Veredito (a palavra apÃ³s os dois pontos e um espaÃ§o)

                        if (!linha || !linha.vibracao_harmonica || !linha.compatibilidade) {
                            return resolve({ porcentagem: 'N/A', veredito: 'NÃ£o encontrado' });
                        }
                        
                        // 1. Extrai a Porcentagem (da linha.vibracao_harmonica)
                        const matchPorcentagem = linha.vibracao_harmonica.match(/(\d+%)/);
                        const porcentagem = matchPorcentagem ? matchPorcentagem[1] : 'N/A';
                        
                        // 2. Extrai o Veredito (da linha.compatibilidade, usando a Regex robusta)
                        // Procura por ': ' seguido por qualquer coisa (.*?) atÃ© encontrar ' -'
                        const matchVeredito = linha.compatibilidade.match(/:\s*(.*?)\s*-/);
                        
                        // .trim() para garantir a palavra completa e limpa
                        const veredito = matchVeredito ? matchVeredito[1].trim() : ''; 
                        
                        // Retorna ambos os valores como um objeto
                        resolve({ porcentagem: porcentagem, veredito: veredito });
                        // Retorna ambos os valores como um objeto
                        resolve({ porcentagem: porcentagem, veredito: veredito });
                    },
                    error: (err) => {
                        console.error("Erro ao carregar CSV:", err);
                        reject({ porcentagem: 'N/A', veredito: 'Erro' });
                    }
                });
            });
        }
        function parseDataBR(str) {
            if (!str) return null;
            const partes = str.split("/");
            if (partes.length !== 3) return null;
            const [dia, mes, ano] = partes;
            return new Date(`${ano}-${mes}-${dia}T00:00:00`);
        }

        // FunÃ§Ã£o principal para calcular e exibir informaÃ§Ãµes comuns (DiferenÃ§a de idade e Compatibilidade)
        async function gerarComum(data1, data2) {
            const comumBox = document.getElementById("comum");
            if (!data1 || !data2) {
                comumBox.innerHTML = "";
                return;
            }
            
            comumBox.innerHTML = `<p>ðŸ”„ Buscando compatibilidade...</p>`;

            const d1 = parseDataBR(data1);
            const d2 = parseDataBR(data2);

            // DiferenÃ§a de idade
            const diff = Math.abs(d1 - d2);
            const dias = diff / (1000 * 60 * 60 * 24);
            const anos = Math.floor(dias / 365.25);

            // --- BUSCA DA COMPATIBILIDADE REAL NO CSV ---
            const info1 = calcularInfo(data1);
            const info2 = calcularInfo(data2);

            // Recebe um objeto com porcentagem E veredito
            const compatibilidade = await buscarCompatibilidadeReal(
                info1 ? info1.diaNascimento : 0, 
                info2 ? info2.diaNascimento : 0
            );
            
            // Formata o Veredito (ex: " - FantÃ¡stico")
            const textoVeredito = compatibilidade.veredito ? ` - ${compatibilidade.veredito}` : '';

            comumBox.innerHTML = `
                <p>ðŸ§® DiferenÃ§a de idade: <strong>${anos}</strong> anos</p>
                <p>ðŸ’ž Compatibilidade bÃ¡sica: <strong>${compatibilidade.porcentagem}${textoVeredito}</strong></p>
            `;
        }
 
        // FunÃ§Ã£o de hash SHA1 (mantida)
        function gerarIdUnicoDatas(data1, data2) {
            // Ordena as datas para que o hash seja consistente
            const datasOrdenadas = [data1, data2].sort(); 
            const base = `${datasOrdenadas[0]}|${datasOrdenadas[1]}`;
            // Verifica se a biblioteca CryptoJS estÃ¡ disponÃ­vel
            if (typeof CryptoJS === 'undefined' || !CryptoJS.SHA1) return 'ID indisponÃ­vel';
            return CryptoJS.SHA1(base).toString();
        }

        // Listener de eventos nos inputs para atualizar os dados
        document.querySelectorAll("input").forEach(inp => {
            inp.addEventListener("input", () => {
                const d1 = document.getElementById("data1").value;
                const d2 = document.getElementById("data2").value;

                mostrarInfo("info1", calcularInfo(d1));
                mostrarInfo("info2", calcularInfo(d2));
                gerarComum(d1, d2); // Chama a funÃ§Ã£o assÃ­ncrona
            });
        });

        // Listener do botÃ£o "Ver meu Par" para salvar e navegar
        document.getElementById("verPar").addEventListener("click", () => {
            const nome1 = document.getElementById("nome1").value;
            const data1 = document.getElementById("data1").value;
            const nome2 = document.getElementById("nome2").value;
            const data2 = document.getElementById("data2").value;
            
            // 1. **GeraÃ§Ã£o do ID Ãšnico (CHAMADA ESSENCIAL)**
            const idUnico = gerarIdUnicoDatas(data1, data2); 

            // Salvando os dados de Luz (Pessoa 1)
            localStorage.setItem("nome1", nome1);
            localStorage.setItem("data1", data1);

            // Salvando os dados de Reflexo (Pessoa 2)
            localStorage.setItem("nome2", nome2);
            localStorage.setItem("data2", data2);
            
            // 2. **Salvando o ID Ãšnico (Com a nova nomenclatura)**
            localStorage.setItem("idUnico_p_ideal", idUnico);




            // 3. Redirecionando para a tela de transiÃ§Ã£o
            window.location.href = "transicao_p_ideal.html";
        });


        // Listener do botÃ£o "SAIR"
        document.getElementById("btnSair").addEventListener("click", () => {
            window.location.href = "index.html"; 
        });

        function mascData(input) {
            let valor = input.value.replace(/\D/g, "");

            if (valor.length > 2 && valor.length <= 4) {
                valor = valor.replace(/(\d{2})(\d+)/, "$1/$2");
            } else if (valor.length > 4) {
                valor = valor.replace(/(\d{2})(\d{2})(\d+)/, "$1/$2/$3");
            }

            input.value = valor;
        }

        document.getElementById("data1").addEventListener("input", function () {
            mascData(this);
        });

        document.getElementById("data2").addEventListener("input", function () {
            mascData(this);
        });
    </script>
</body>
</html>